<!DOCTYPE html>
<html>
<head>
    <title>SignalR Simple Chat</title>
    <style type="text/css">
        .container {
            background-color: #99CCFF;
            border: thick solid #808080;
            padding: 20px;
            margin: 20px;
        }
        .container ul{
            word-break:break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <input type="text" id="message" />
        <input type="button" id="sendmessage" value="Send" />
        <label id="lblConnectionID"></label>
        <a href="SendMsg.html" target="_blank">SendMsg</a>

        <input type="hidden" id="displayname" />
        <ul id="discussion"></ul>
    </div>
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-1.6.4.min.js"></script>
    <script src="Scripts/jquery.cookie.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.2.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="/signalr/hubs"></script>
    <script type="text/javascript">
        Date.prototype.Format = function (fmt) { //author: meizz 
            if (fmt == null || fmt == '' || fmt == undefined) fmt = "yyyy-MM-dd";
            var o = {
                "M+": this.getMonth() + 1, //月份 
                "d+": this.getDate(), //日    
                "h+": this.getHours() == 0 ? 12 : this.getHours(), //小时       
                "H+": this.getHours(), //小时 
                "m+": this.getMinutes(), //分 
                "s+": this.getSeconds(), //秒 
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
                "S": this.getMilliseconds() //毫秒 
            };
            if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (var k in o)
                if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            return fmt;
        }
    </script>
    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">
        $(function () {
            // Declare a proxy to reference the hub.
            var hub = $.connection.arcConcentratorHub;
            // Create a function that the hub can call to broadcast messages.
            hub.client.keepAlive = function (json) {
                //console.log(json);
                $('#discussion').prepend('<li><b>【' + new Date().Format('HH:mm:ss') + '】keepAlive:</b>' + json + '</li>');
            };
            hub.client.commandDownload = function (json) {
                //console.log(json);
                $('#discussion').prepend('<li><b>【' + new Date().Format('HH:mm:ss') + '】commandDownload:</b>' + json + '</li>');
            };
            hub.client.commandUpload = function (json) {
                //console.log(json);
                $('#discussion').prepend('<li><b>【' + new Date().Format('HH:mm:ss') + '】commandUpload:</b>' + json + '</li>');
            };
            // Get the user name and store it to prepend to messages.
            //$('#displayname').val(prompt('Enter your name:', ''));
            // Set initial focus to message input box.
            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {
                //prompt($.connection.hub.id, $.connection.hub.id)
                var name = "CID";
                var cid=$.cookie(name);
                if ( cid== null) {
                    hub.server.getConnectionID().done(function (ret) {
                        $.cookie(name, ret);
                        $("#lblConnectionID").html("My ConnectionID:" + ret);
                    });
                }
                else $("#lblConnectionID").html("My ConnectionID:" + cid);

                $('#sendmessage').click(function () {
                    // Call the Send method on the hub.
                    //chat.server.send($('#displayname').val(), $('#message').val());
                    //var d = { name: "objName", msg: "ObjMsg" };
                    hub.server.commandDownload($('#message').val());
                    // Clear text box and reset focus for next comment.
                    $('#message').val('').focus();
                }); 
            });
        });
    </script>
</body>
</html>
